#!/usr/bin/env python3
"""
Testes espec√≠ficos para o sistema multi-agente
"""

import asyncio
import json
import subprocess
import sys
import time
from pathlib import Path

import httpx

# Configura√ß√£o
API_HOST = "127.0.0.1"
API_PORT = 8000
API_BASE_URL = f"http://{API_HOST}:{API_PORT}"


class MultiAgentTester:
    def __init__(self):
        self.server_process = None
        self.client = httpx.Client(timeout=60.0)  # Timeout maior para multi-agent
    
    def start_server_dev_mode(self):
        """Inicia o servidor em modo desenvolvimento"""
        print("üöÄ Iniciando servidor para testes multi-agente...")
        
        # Configurar vari√°veis de ambiente para modo dev
        import os
        env = os.environ.copy()
        env["PRODUCTION_MODE"] = "false"
        env["API_BEARER_TOKEN"] = ""  # Token vazio para modo dev
        
        cmd = [
            sys.executable, "-m", "uvicorn", 
            "api.main:app", 
            "--host", API_HOST, 
            "--port", str(API_PORT),
            "--log-level", "info"
        ]
        
        try:
            self.server_process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                env=env
            )
            
            print("‚è≥ Aguardando servidor inicializar (20s para multi-agente)...")
            time.sleep(20)  # Mais tempo para inicializa√ß√£o do sistema multi-agente
            
            if self.server_process.poll() is None:
                print("‚úÖ Servidor iniciado")
                return True
            else:
                print("‚ùå Servidor falhou ao iniciar")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro ao iniciar servidor: {e}")
            return False
    
    def stop_server(self):
        """Para o servidor da API"""
        if self.server_process:
            print("üõë Parando servidor...")
            self.server_process.terminate()
            self.server_process.wait()
            print("‚úÖ Servidor parado")
    
    def test_lead_researcher_components(self):
        """Testa os componentes do Lead Researcher"""
        print("\\nü§ñ TESTANDO COMPONENTES DO LEAD RESEARCHER")
        print("-" * 60)
        
        results = {
            "debug_access": False,
            "lead_researcher_available": False,
            "rag_system_connected": False,
            "reasoning_system": False,
            "agent_configuration": False
        }
        
        try:
            # 1. Verificar debug do sistema
            print("üìç Acessando debug do sistema multi-agente...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/research/debug")
            
            if response.status_code == 200:
                data = response.json()
                print("   ‚úÖ Debug acess√≠vel")
                results["debug_access"] = True
                
                # Verificar componentes
                components = data.get("components", {})
                lead_available = components.get("lead_researcher_available", False)
                rag_available = components.get("simple_rag_available", False)
                
                print(f"      - Lead Researcher: {lead_available}")
                print(f"      - SimpleRAG: {rag_available}")
                
                if lead_available:
                    results["lead_researcher_available"] = True
                    print("   ‚úÖ Lead Researcher dispon√≠vel")
                
                if rag_available:
                    results["rag_system_connected"] = True
                    print("   ‚úÖ Sistema RAG conectado")
                
                # Verificar informa√ß√µes detalhadas do Lead Researcher
                lead_info = data.get("lead_researcher_info", {})
                if lead_info:
                    agent_id = lead_info.get("agent_id", "N/A")
                    agent_name = lead_info.get("name", "N/A")
                    has_rag = lead_info.get("has_rag_system", False)
                    
                    print(f"      - Agent ID: {agent_id}")
                    print(f"      - Agent Name: {agent_name}")
                    print(f"      - RAG System: {has_rag}")
                    
                    if agent_id != "N/A" and agent_name != "N/A":
                        results["agent_configuration"] = True
                        print("   ‚úÖ Configura√ß√£o do agente v√°lida")
                    
                    if has_rag:
                        results["reasoning_system"] = True
                        print("   ‚úÖ Sistema de reasoning configurado")
            else:
                print(f"   ‚ùå Debug n√£o acess√≠vel - {response.status_code}")
        
        except Exception as e:
            print(f"‚ùå Erro ao testar componentes: {e}")
        
        return results
    
    def test_multi_agent_reasoning(self):
        """Testa as capacidades de reasoning multi-agente"""
        print("\\nüß† TESTANDO REASONING MULTI-AGENTE")
        print("-" * 60)
        
        results = {
            "planning_phase": False,
            "reasoning_test": False,
            "complex_query_handling": False,
            "agent_collaboration": False
        }
        
        try:
            # 1. Teste de planning
            print("üìç Testando fase de planning...")
            planning_query = {
                "query": "Explain the transformer architecture and its impact on modern AI",
                "objective": "Provide comprehensive analysis for AI researchers"
            }
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/test-reasoning",
                json=planning_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    plan_created = data.get("plan_created", False)
                    plan_tasks = data.get("plan_tasks", 0)
                    
                    print(f"   ‚úÖ Planning executado")
                    print(f"      - Plano criado: {plan_created}")
                    print(f"      - Tarefas no plano: {plan_tasks}")
                    
                    if plan_created and plan_tasks > 0:
                        results["planning_phase"] = True
                        print("   ‚úÖ Sistema de planning funcionando")
                    
                    # Verificar informa√ß√µes sobre reasoning
                    reasoning_available = data.get("reasoning_available", False)
                    reasoning_type = data.get("reasoning_type", "N/A")
                    
                    print(f"      - Reasoning dispon√≠vel: {reasoning_available}")
                    print(f"      - Tipo de reasoning: {reasoning_type}")
                    
                    if reasoning_available:
                        results["reasoning_test"] = True
                        print("   ‚úÖ Sistema de reasoning ativo")
                else:
                    print(f"   ‚ö†Ô∏è Planning falhou: {data.get('error')}")
            else:
                print(f"   ‚ùå Teste de reasoning falhou - {response.status_code}")
            
            # 2. Teste de consulta complexa
            print("\\nüìç Testando consulta complexa...")
            complex_query = {
                "query": "Compare different attention mechanisms in neural networks and their computational complexity",
                "objective": "Detailed technical comparison for machine learning engineers"
            }
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research",
                json=complex_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    result_length = len(data.get("result", ""))
                    processing_time = data.get("processing_time", 0)
                    status = data.get("status", "UNKNOWN")
                    reasoning_trace = data.get("reasoning_trace")
                    
                    print(f"   ‚úÖ Consulta complexa processada")
                    print(f"      - Status: {status}")
                    print(f"      - Tempo: {processing_time:.2f}s")
                    print(f"      - Resultado: {result_length} caracteres")
                    print(f"      - Reasoning trace: {'Dispon√≠vel' if reasoning_trace else 'N/A'}")
                    
                    if status == "COMPLETED" and result_length > 100:
                        results["complex_query_handling"] = True
                        print("   ‚úÖ Processamento de consulta complexa funcional")
                    
                    if reasoning_trace:
                        results["agent_collaboration"] = True
                        print("   ‚úÖ Sistema de colabora√ß√£o entre agentes ativo")
                else:
                    print(f"   ‚ö†Ô∏è Consulta complexa falhou: {data.get('error')}")
            else:
                print(f"   ‚ùå Consulta complexa falhou - {response.status_code}")
        
        except Exception as e:
            print(f"‚ùå Erro ao testar reasoning: {e}")
        
        return results
    
    def test_agent_context_memory(self):
        """Testa o sistema de contexto e mem√≥ria dos agentes"""
        print("\\nüß≠ TESTANDO CONTEXTO E MEM√ìRIA DOS AGENTES")
        print("-" * 60)
        
        results = {
            "context_creation": False,
            "memory_system": False,
            "context_persistence": False,
            "multi_turn_conversation": False
        }
        
        try:
            # 1. Teste de cria√ß√£o de contexto
            print("üìç Testando cria√ß√£o de contexto...")
            
            # Primeira consulta para criar contexto
            first_query = {
                "query": "What are the key components of a transformer model?",
                "objective": "Understand basic architecture"
            }
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research",
                json=first_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    agent_id = data.get("agent_id", "")
                    timestamp = data.get("timestamp", "")
                    
                    print(f"   ‚úÖ Contexto criado")
                    print(f"      - Agent ID: {agent_id}")
                    print(f"      - Timestamp: {timestamp}")
                    
                    if agent_id and timestamp:
                        results["context_creation"] = True
                        print("   ‚úÖ Sistema de contexto funcionando")
            
            # 2. Verificar sistema de mem√≥ria
            print("\\nüìç Verificando sistema de mem√≥ria...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/research/debug")
            
            if response.status_code == 200:
                data = response.json()
                api_state = data.get("api_state", {})
                ready = api_state.get("ready", False)
                
                if ready:
                    print("   ‚úÖ Sistema de mem√≥ria inicializado")
                    results["memory_system"] = True
            
            # 3. Teste de persist√™ncia de contexto (consulta relacionada)
            print("\\nüìç Testando persist√™ncia de contexto...")
            related_query = {
                "query": "How does self-attention work in those models?",
                "objective": "Build on previous knowledge about transformers"
            }
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research",
                json=related_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    result = data.get("result", "")
                    
                    # Verificar se a resposta faz refer√™ncia ao contexto anterior
                    context_indicators = [
                        "transformer", "attention", "model", "architecture",
                        "previous", "earlier", "mentioned", "discussed"
                    ]
                    
                    context_references = sum(1 for indicator in context_indicators 
                                           if indicator.lower() in result.lower())
                    
                    print(f"   ‚úÖ Consulta relacionada processada")
                    print(f"      - Refer√™ncias contextuais: {context_references}")
                    
                    if context_references >= 2:
                        results["context_persistence"] = True
                        print("   ‚úÖ Persist√™ncia de contexto funcionando")
                    
                    results["multi_turn_conversation"] = True
                    print("   ‚úÖ Conversa√ß√£o multi-turno ativa")
        
        except Exception as e:
            print(f"‚ùå Erro ao testar contexto e mem√≥ria: {e}")
        
        return results
    
    def test_agent_rag_integration(self):
        """Testa a integra√ß√£o entre agentes e sistema RAG"""
        print("\\nüîó TESTANDO INTEGRA√á√ÉO AGENTE-RAG")
        print("-" * 60)
        
        results = {
            "direct_rag_access": False,
            "agent_rag_integration": False,
            "rag_result_processing": False,
            "fallback_handling": False
        }
        
        try:
            # 1. Teste de acesso direto ao RAG
            print("üìç Testando acesso direto ao SimpleRAG...")
            rag_query = {"query": "transformer architecture"}
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/simple",
                json=rag_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    result_length = data.get("result_length", 0)
                    processing_time = data.get("processing_time", 0)
                    
                    print(f"   ‚úÖ RAG direto funcionando")
                    print(f"      - Resultado: {result_length} caracteres")
                    print(f"      - Tempo: {processing_time:.3f}s")
                    
                    if result_length > 0:
                        results["direct_rag_access"] = True
                        print("   ‚úÖ Acesso direto ao RAG funcional")
            
            # 2. Teste de integra√ß√£o via Lead Researcher
            print("\\nüìç Testando RAG via Lead Researcher...")
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/direct",
                json=rag_query
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    result = data.get("result", "")
                    confidence = data.get("confidence_score", 0)
                    sources = data.get("sources", [])
                    
                    print(f"   ‚úÖ RAG via Lead Researcher funcionando")
                    print(f"      - Confian√ßa: {confidence}")
                    print(f"      - Fontes: {sources}")
                    print(f"      - Resultado: {len(result)} caracteres")
                    
                    if len(result) > 0:
                        results["agent_rag_integration"] = True
                        print("   ‚úÖ Integra√ß√£o Agente-RAG funcional")
                    
                    if confidence > 0 or sources:
                        results["rag_result_processing"] = True
                        print("   ‚úÖ Processamento de resultados RAG ativo")
            
            # 3. Teste de fallback quando n√£o h√° resultados
            print("\\nüìç Testando fallback para consultas sem resultados...")
            empty_query = {"query": "xyzabc123nonexistent"}
            
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/simple",
                json=empty_query
            )
            
            if response.status_code == 200:
                data = response.json()
                success = data.get("success", False)
                diagnostic = data.get("diagnostic", {})
                
                print(f"   ‚úÖ Fallback testado")
                print(f"      - Success: {success}")
                print(f"      - Diagn√≥stico: {diagnostic}")
                
                # Se o sistema retornou uma resposta estruturada mesmo sem resultados
                if not success and diagnostic:
                    results["fallback_handling"] = True
                    print("   ‚úÖ Sistema de fallback funcionando")
        
        except Exception as e:
            print(f"‚ùå Erro ao testar integra√ß√£o RAG: {e}")
        
        return results
    
    def test_system_status_detailed(self):
        """Testa o status detalhado do sistema multi-agente"""
        print("\\nüìä TESTANDO STATUS DETALHADO DO SISTEMA")
        print("-" * 60)
        
        results = {
            "system_health": False,
            "component_status": False,
            "performance_metrics": False,
            "initialization_status": False
        }
        
        try:
            # 1. Health check completo
            print("üìç Verificando health check completo...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/health")
            
            if response.status_code == 200:
                data = response.json()
                status = data.get("status", "unknown")
                components = data.get("components", {})
                metrics = data.get("metrics", {})
                
                print(f"   ‚úÖ Health check OK - Status: {status}")
                print(f"      - Componentes: {components}")
                
                if status == "healthy":
                    results["system_health"] = True
                    print("   ‚úÖ Sistema saud√°vel")
                
                # Verificar componentes espec√≠ficos
                required_components = ["memory", "lead_researcher", "simple_rag"]
                available_components = sum(1 for comp in required_components 
                                         if components.get(comp, False))
                
                print(f"      - Componentes dispon√≠veis: {available_components}/{len(required_components)}")
                
                if available_components == len(required_components):
                    results["component_status"] = True
                    print("   ‚úÖ Todos os componentes principais dispon√≠veis")
                
                # Verificar m√©tricas
                if metrics:
                    total_requests = metrics.get("total_requests", 0)
                    success_rate = metrics.get("success_rate", 0)
                    
                    print(f"      - Total de requests: {total_requests}")
                    print(f"      - Taxa de sucesso: {success_rate}%")
                    
                    results["performance_metrics"] = True
                    print("   ‚úÖ M√©tricas de performance dispon√≠veis")
            
            # 2. Status de pesquisa
            print("\\nüìç Verificando status de pesquisa...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/research/status")
            
            if response.status_code == 200:
                data = response.json()
                research_ready = data.get("research_system_ready", False)
                lead_researcher = data.get("lead_researcher", {})
                
                print(f"   ‚úÖ Status de pesquisa acess√≠vel")
                print(f"      - Sistema pronto: {research_ready}")
                print(f"      - Lead Researcher: {lead_researcher}")
                
                if research_ready and lead_researcher.get("available"):
                    results["initialization_status"] = True
                    print("   ‚úÖ Sistema de pesquisa totalmente inicializado")
        
        except Exception as e:
            print(f"‚ùå Erro ao verificar status: {e}")
        
        return results
    
    def run_multiagent_tests(self):
        """Executa todos os testes do sistema multi-agente"""
        print("ü§ñ TESTES COMPLETOS DO SISTEMA MULTI-AGENTE")
        print("=" * 80)
        
        # Iniciar servidor
        if not self.start_server_dev_mode():
            return False
        
        try:
            # Aguardar inicializa√ß√£o completa
            print("‚è≥ Aguardando inicializa√ß√£o completa dos agentes...")
            time.sleep(5)
            
            # Executar todos os grupos de testes
            status_results = self.test_system_status_detailed()
            component_results = self.test_lead_researcher_components()
            reasoning_results = self.test_multi_agent_reasoning()
            memory_results = self.test_agent_context_memory()
            integration_results = self.test_agent_rag_integration()
            
            # Calcular estat√≠sticas finais
            print("\\n" + "=" * 80)
            print("üìä RESULTADOS FINAIS DO SISTEMA MULTI-AGENTE:")
            
            all_results = [
                ("üîç STATUS DO SISTEMA", status_results),
                ("ü§ñ COMPONENTES DO LEAD RESEARCHER", component_results),
                ("üß† REASONING MULTI-AGENTE", reasoning_results),
                ("üß≠ CONTEXTO E MEM√ìRIA", memory_results),
                ("üîó INTEGRA√á√ÉO AGENTE-RAG", integration_results)
            ]
            
            total_passed = 0
            total_tests = 0
            
            for section_name, section_results in all_results:
                passed = sum(section_results.values())
                total = len(section_results)
                total_passed += passed
                total_tests += total
                
                print(f"\\n{section_name}: {passed}/{total} testes passaram")
                for test, result in section_results.items():
                    status = "‚úÖ" if result else "‚ùå"
                    print(f"   {status} {test}")
            
            # Resultado geral
            success_rate = (total_passed / total_tests) * 100
            print(f"\\nüéØ RESULTADO GERAL: {total_passed}/{total_tests} ({success_rate:.1f}%) testes passaram")
            
            if success_rate >= 80:
                print("üéâ EXCELENTE! O sistema multi-agente est√° funcionando muito bem!")
                return True
            elif success_rate >= 60:
                print("üëç BOM! O sistema multi-agente est√° operacional.")
                return True
            else:
                print("‚ö†Ô∏è ATEN√á√ÉO! O sistema multi-agente precisa de configura√ß√£o.")
                return False
                
        finally:
            self.stop_server()
            self.client.close()


def main():
    """Fun√ß√£o principal"""
    try:
        tester = MultiAgentTester()
        success = tester.run_multiagent_tests()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\\nüõë Testes interrompidos pelo usu√°rio")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå Erro durante os testes: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()