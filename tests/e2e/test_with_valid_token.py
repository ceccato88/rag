#!/usr/bin/env python3
"""
Teste das rotas com token v√°lido em modo desenvolvimento
"""

import os
import subprocess
import sys
import time
from pathlib import Path

import httpx

# Configura√ß√£o
API_HOST = "127.0.0.1"
API_PORT = 8000
API_BASE_URL = f"http://{API_HOST}:{API_PORT}"


class AuthenticatedRouteTester:
    def __init__(self):
        self.server_process = None
        self.client = httpx.Client(timeout=30.0)
    
    def start_server_dev_mode(self):
        """Inicia o servidor em modo desenvolvimento (sem autentica√ß√£o)"""
        print("üöÄ Iniciando servidor em modo desenvolvimento...")
        
        # Configurar vari√°veis de ambiente para modo dev
        env = os.environ.copy()
        env["PRODUCTION_MODE"] = "false"
        env["API_BEARER_TOKEN"] = ""  # Token vazio para modo dev
        
        cmd = [
            sys.executable, "-m", "uvicorn", 
            "api.main:app", 
            "--host", API_HOST, 
            "--port", str(API_PORT),
            "--log-level", "info"
        ]
        
        try:
            self.server_process = subprocess.Popen(
                cmd,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                env=env
            )
            
            print("‚è≥ Aguardando servidor inicializar...")
            time.sleep(15)  # Aguarda 15 segundos para inicializa√ß√£o completa
            
            if self.server_process.poll() is None:
                print("‚úÖ Servidor iniciado em modo desenvolvimento")
                return True
            else:
                print("‚ùå Servidor falhou ao iniciar")
                return False
                
        except Exception as e:
            print(f"‚ùå Erro ao iniciar servidor: {e}")
            return False
    
    def stop_server(self):
        """Para o servidor da API"""
        if self.server_process:
            print("üõë Parando servidor...")
            self.server_process.terminate()
            self.server_process.wait()
            print("‚úÖ Servidor parado")
    
    def test_indexing_with_auth(self):
        """Testa indexa√ß√£o com autentica√ß√£o v√°lida (modo dev)"""
        print("\\nüîÑ TESTANDO INDEXA√á√ÉO COM AUTENTICA√á√ÉO (MODO DEV)")
        print("-" * 50)
        
        results = {
            "status_check": False,
            "url_validation": False,
            "valid_indexing_request": False,
            "indexing_flow": False
        }
        
        try:
            # 1. Verificar status do indexer
            print("üìç Verificando status do indexer...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/index/status")
            if response.status_code == 200:
                data = response.json()
                indexer_available = data.get("indexer_available", False)
                print(f"   ‚úÖ Status OK - Indexer dispon√≠vel: {indexer_available}")
                results["status_check"] = True
            else:
                print(f"   ‚ùå Falha no status - {response.status_code}")
            
            # 2. Validar URL
            print("üìç Validando URL de teste...")
            test_url = "https://arxiv.org/pdf/1706.03762.pdf"
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/index/validate-url",
                json={"url": test_url}
            )
            if response.status_code == 200:
                data = response.json()
                if data.get("valid") is True:
                    print(f"   ‚úÖ URL v√°lida - Doc source: {data.get('generated_doc_source')}")
                    results["url_validation"] = True
                else:
                    print(f"   ‚ùå URL inv√°lida - {data.get('error')}")
            else:
                print(f"   ‚ùå Falha na valida√ß√£o - {response.status_code}")
            
            # 3. Tentar indexa√ß√£o real (sem autentica√ß√£o - modo dev)
            print("üìç Testando indexa√ß√£o em modo desenvolvimento...")
            index_payload = {
                "url": test_url,
                "doc_source": "test-paper-attention"
            }
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/index",
                json=index_payload
            )
            
            print(f"   Status da resposta: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    print(f"   ‚úÖ Indexa√ß√£o bem-sucedida!")
                    print(f"      - P√°ginas: {data.get('pages_processed', 0)}")
                    print(f"      - Chunks: {data.get('chunks_created', 0)}")
                    print(f"      - Tempo: {data.get('processing_time', 0):.2f}s")
                    results["valid_indexing_request"] = True
                    results["indexing_flow"] = True
                else:
                    print(f"   ‚ö†Ô∏è Indexa√ß√£o falhou: {data.get('message')}")
                    results["valid_indexing_request"] = True  # Request v√°lido, mas falha interna
            elif response.status_code in [401, 503]:
                print("   ‚ö†Ô∏è Ainda est√° protegido por autentica√ß√£o ou servi√ßo indispon√≠vel")
                results["valid_indexing_request"] = True  # Request v√°lido, sistema n√£o configurado
            else:
                print(f"   ‚ùå Erro inesperado: {response.status_code}")
                try:
                    error_data = response.json()
                    print(f"      Erro: {error_data}")
                except:
                    print(f"      Resposta: {response.text[:200]}")
        
        except Exception as e:
            print(f"‚ùå Erro nos testes de indexa√ß√£o: {e}")
        
        return results
    
    def test_research_with_auth(self):
        """Testa pesquisa com autentica√ß√£o v√°lida (modo dev)"""
        print("\\nüîç TESTANDO RESEARCH COM AUTENTICA√á√ÉO (MODO DEV)")
        print("-" * 50)
        
        results = {
            "basic_research": False,
            "simple_rag": False,
            "direct_research": False,
            "debug_info": False
        }
        
        try:
            # 1. Teste de pesquisa b√°sica
            print("üìç Testando pesquisa b√°sica...")
            query_payload = {"query": "What is transformer architecture in deep learning?"}
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research",
                json=query_payload
            )
            
            print(f"   Status da resposta: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    print(f"   ‚úÖ Pesquisa bem-sucedida!")
                    print(f"      - Status: {data.get('status')}")
                    print(f"      - Tempo: {data.get('processing_time', 0):.2f}s")
                    print(f"      - Resultado: {data.get('result', '')[:100]}...")
                    results["basic_research"] = True
                else:
                    print(f"   ‚ö†Ô∏è Pesquisa retornou erro: {data.get('error')}")
            elif response.status_code in [401, 503]:
                print("   ‚ö†Ô∏è Ainda est√° protegido por autentica√ß√£o ou servi√ßo indispon√≠vel")
            else:
                print(f"   ‚ùå Erro inesperado: {response.status_code}")
            
            # 2. Teste de RAG simples
            print("üìç Testando SimpleRAG...")
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/simple",
                json=query_payload
            )
            
            print(f"   Status da resposta: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    print(f"   ‚úÖ SimpleRAG funcionando!")
                    print(f"      - Resultado: {len(data.get('result', ''))} caracteres")
                    results["simple_rag"] = True
                else:
                    print(f"   ‚ö†Ô∏è SimpleRAG sem resultados: {data.get('result')}")
            elif response.status_code in [401, 503]:
                print("   ‚ö†Ô∏è Ainda est√° protegido ou servi√ßo indispon√≠vel")
            
            # 3. Teste de pesquisa direta
            print("üìç Testando pesquisa direta...")
            response = self.client.post(
                f"{API_BASE_URL}/api/v1/research/direct",
                json=query_payload
            )
            
            print(f"   Status da resposta: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                if data.get("success"):
                    print(f"   ‚úÖ Pesquisa direta funcionando!")
                    results["direct_research"] = True
                else:
                    print(f"   ‚ö†Ô∏è Pesquisa direta sem resultados")
            elif response.status_code in [401, 503]:
                print("   ‚ö†Ô∏è Ainda est√° protegido ou servi√ßo indispon√≠vel")
            
            # 4. Teste de debug
            print("üìç Testando debug do sistema...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/research/debug")
            
            print(f"   Status da resposta: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                print("   ‚úÖ Debug acess√≠vel!")
                print(f"      - API ready: {data.get('api_state', {}).get('ready', False)}")
                print(f"      - Lead researcher: {data.get('components', {}).get('lead_researcher_available', False)}")
                print(f"      - SimpleRAG: {data.get('components', {}).get('simple_rag_available', False)}")
                results["debug_info"] = True
            elif response.status_code in [401, 503]:
                print("   ‚ö†Ô∏è Debug protegido ou servi√ßo indispon√≠vel")
        
        except Exception as e:
            print(f"‚ùå Erro nos testes de research: {e}")
        
        return results
    
    def test_system_readiness(self):
        """Testa se o sistema est√° totalmente inicializado"""
        print("\\nüè• TESTANDO PRONTID√ÉO DO SISTEMA")
        print("-" * 50)
        
        results = {
            "health_check": False,
            "system_components": False,
            "api_metrics": False
        }
        
        try:
            # 1. Health check
            print("üìç Testando health check...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/health")
            if response.status_code == 200:
                data = response.json()
                status = data.get("status", "unknown")
                print(f"   ‚úÖ Health check OK - Status: {status}")
                print(f"      - Uptime: {data.get('uptime_seconds', 0):.1f}s")
                print(f"      - Componentes: {data.get('components', {})}")
                results["health_check"] = True
                
                # Verificar componentes espec√≠ficos
                components = data.get("components", {})
                if components.get("lead_researcher") and components.get("simple_rag"):
                    print("   ‚úÖ Componentes principais dispon√≠veis")
                    results["system_components"] = True
                else:
                    print("   ‚ö†Ô∏è Alguns componentes n√£o est√£o dispon√≠veis")
            
            # 2. M√©tricas
            print("üìç Testando m√©tricas...")
            response = self.client.get(f"{API_BASE_URL}/api/v1/stats")
            if response.status_code == 200:
                data = response.json()
                print(f"   ‚úÖ M√©tricas dispon√≠veis")
                print(f"      - API ready: {data.get('api_ready', False)}")
                print(f"      - Multi-agent: {data.get('multiagent_initialized', False)}")
                print(f"      - Requests: {data.get('total_requests', 0)}")
                results["api_metrics"] = True
        
        except Exception as e:
            print(f"‚ùå Erro nos testes de sistema: {e}")
        
        return results
    
    def run_authenticated_tests(self):
        """Executa todos os testes em modo autenticado"""
        print("üß™ TESTES COM AUTENTICA√á√ÉO V√ÅLIDA (MODO DESENVOLVIMENTO)")
        print("=" * 80)
        
        # Iniciar servidor em modo dev
        if not self.start_server_dev_mode():
            return False
        
        try:
            # Aguardar inicializa√ß√£o completa
            print("‚è≥ Aguardando inicializa√ß√£o completa do sistema...")
            time.sleep(5)
            
            # Executar todos os testes
            system_results = self.test_system_readiness()
            indexing_results = self.test_indexing_with_auth()
            research_results = self.test_research_with_auth()
            
            # Calcular estat√≠sticas
            print("\\n" + "=" * 80)
            print("üìä RESULTADOS DOS TESTES AUTENTICADOS:")
            
            # Sistema
            system_passed = sum(system_results.values())
            system_total = len(system_results)
            print(f"\\nüè• SISTEMA: {system_passed}/{system_total} testes passaram")
            for test, passed in system_results.items():
                status = "‚úÖ" if passed else "‚ùå"
                print(f"   {status} {test}")
            
            # Indexa√ß√£o
            indexing_passed = sum(indexing_results.values())
            indexing_total = len(indexing_results)
            print(f"\\nüîÑ INDEXA√á√ÉO: {indexing_passed}/{indexing_total} testes passaram")
            for test, passed in indexing_results.items():
                status = "‚úÖ" if passed else "‚ùå"
                print(f"   {status} {test}")
            
            # Research
            research_passed = sum(research_results.values())
            research_total = len(research_results)
            print(f"\\nüîç RESEARCH: {research_passed}/{research_total} testes passaram")
            for test, passed in research_results.items():
                status = "‚úÖ" if passed else "‚ùå"
                print(f"   {status} {test}")
            
            # Resultado geral
            total_passed = system_passed + indexing_passed + research_passed
            total_tests = system_total + indexing_total + research_total
            success_rate = (total_passed / total_tests) * 100
            
            print(f"\\nüéØ RESULTADO GERAL: {total_passed}/{total_tests} ({success_rate:.1f}%) testes passaram")
            
            if success_rate >= 70:
                print("üéâ EXCELENTE! As rotas est√£o funcionando bem!")
                return True
            elif success_rate >= 50:
                print("üëç BOM! A maioria das funcionalidades est√° operacional.")
                return True
            else:
                print("‚ö†Ô∏è ATEN√á√ÉO! Muitas funcionalidades precisam de configura√ß√£o.")
                return False
                
        finally:
            self.stop_server()
            self.client.close()


def main():
    """Fun√ß√£o principal"""
    try:
        tester = AuthenticatedRouteTester()
        success = tester.run_authenticated_tests()
        sys.exit(0 if success else 1)
    except KeyboardInterrupt:
        print("\\nüõë Testes interrompidos pelo usu√°rio")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå Erro durante os testes: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()